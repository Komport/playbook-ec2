---
- name: Copy idservice.xml
  copy:
    src: idservice.xml
    dest: "{{tomcat_dir}}/Catalina/localhost/"
    owner: root
    group: "{{tomcat_group}}"
    mode: 0644
  notify: Restart_tomcat.service

- name: Create dir of idservice/WEB-INF/lib
  file:
    path: "{{qbroker_dir}}/{{item}}"
    state: directory
    owner: "{{tomcat_user}}"
    group: "{{tomcat_group}}"
    mode: 0755
  with_items:
    - idservice
    - idservice/WEB-INF
    - idservice/WEB-INF/lib

- name: Copy web.xml
  copy:
    src: web.xml
    dest: "{{qbroker_dir}}/idservice/WEB-INF/"
    owner: "{{tomcat_user}}"
    group: "{{tomcat_group}}"
    mode: 0644
  notify: Restart_tomcat.service

- name: Copy jsp files
  copy:
    src: "jsp/{{item}}"
    dest: "{{qbroker_dir}}/idservice/"
    owner: "{{tomcat_user}}"
    group: "{{tomcat_group}}"
    mode: 0644
  with_items: "{{idservice_jsp_files}}"

- name: Create dir of ID
  file:
    path: "{{qbroker_dir}}/flow/ID"
    state: directory
    owner: "{{tomcat_user}}"
    group: "{{tomcat_group}}"
    mode: 0755

- name: Copy json files
  copy:
    src: "flow/{{item}}"
    dest: "{{qbroker_dir}}/flow/ID/"
    owner: "{{tomcat_user}}"
    group: "{{tomcat_group}}"
    mode: 0644
  with_items: "{{idservice_json_files}}"
  notify: Restart_tomcat.service

- name: Template of Flow.json
  template:
    src: Flow.json.j2
    dest: "{{qbroker_dir}}/flow/ID/Flow.json"
    owner: "{{tomcat_user}}"
    group: "{{tomcat_group}}"
    mode: 0644
  vars:
    log_dir: "{{tomcat_logdir}}"
  notify: Restart_tomcat.service

- name: Template of node_collect.json
  template:
    src: node_collect.json.j2
    dest: "{{qbroker_dir}}/flow/ID/node_collect.json"
    owner: "{{tomcat_user}}"
    group: "{{tomcat_group}}"
    mode: 0644
  vars:
    db_type: "{{ 'postgresql' if web_frontend == 'nginx' else 'mysql' }}"
  notify: Restart_tomcat

- name: Template of pstr_db_query.json for postgresql
  template:
    src: pstr_db_query.json.j2
    dest: "{{qbroker_dir}}/flow/ID/pstr_db_query.json"
    owner: "{{tomcat_user}}"
    group: "{{tomcat_group}}"
    mode: 0644
  vars:
    db_type: postgresql
    db_port: "{{postgresql_port}}"
    db_name: "{{postgresql_db_name}}"
    db_user: "{{postgresql_db_user}}"
    db_passwd: "{{postgresql_db_passwd}}"
  when: web_frontend == 'nginx'
  notify: Restart_tomcat.service

- name: Template of pstr_db_query.json for mysql
  template:
    src: pstr_db_query.json.j2
    dest: "{{qbroker_dir}}/flow/ID/pstr_db_query.json"
    owner: "{{tomcat_user}}"
    group: "{{tomcat_group}}"
    mode: 0644
  vars:
    db_type: mysql
    db_port: "{{mysql_port}}"
    db_name: "{{mysql_db_name}}"
    db_user: "{{mysql_db_user}}"
    db_passwd: "{{mysql_db_passwd}}"
  when: web_frontend == 'apache'
  notify: Restart_tomcat.service

- name: Copy jar files
  copy:
    src: "{{qbroker_dir}}/lib/{{item}}"
    dest: "{{qbroker_dir}}/idservice/WEB-INF/lib/"
    remote_src: yes
    force: no
    owner: "{{tomcat_user}}"
    group: "{{tomcat_group}}"
    mode: 0644
  with_items: "{{idservice_jar_files}}"
  notify: Restart_tomcat.service
