---
- name: Terminate queried instances in {{aws_region}}
  ec2:
    state: 'absent'
    region: "{{aws_region}}"
    instance_ids: "{{item.id}}"
  with_items: "{{ec2_info.instances}}"
  when: ec2_info.instances|length > 0

- name: Pause for a minute
  pause:
    seconds: 60
  when: ec2_info.instances|length > 0

- name: Get ec2 security group facts (boto3 required)
  ec2_group_facts:
    region: "{{aws_region}}"
    filters:
      vpc_id: "{{vpc_id}}"
      group_name: "{{sg_name}}"
  register: ec2_sg_info

- name: Take security group down
  ec2_group:
    name: "{{sg_name}}"
    region: "{{aws_region}}"
    state: 'absent'
  when: ec2_info.instances|length > 0 or ec2_sg_info.security_groups|length > 0
